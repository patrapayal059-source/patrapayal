<!-- profile.html -->
{% extends "base.html" %}
{% block content %}

<h2 class="page-title">Users List</h2>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for cat, msg in messages %}
    {% if cat != 'book' %}
      <div class="flash-message {{ cat }}">{{ msg }}</div>
    {% endif %}
  {% endfor %}
{% endwith %}


<!-- ================= ADD USER FORM ================= -->
<div class="add-user-container">
    <h3>‚ûï Add User</h3>

    <form method="post" action="{{ url_for('users.add_user') }}">
        <label>Username</label>
        <input type="text" name="username" required>

        <label>Roll No</label>
        <input type="text" name="roll_no" required>

        <label>Department</label>
        <input type="text" name="department" required>

        <button type="submit">Add User</button>
    </form>
</div>

<!-- ================= USERS TABLE ================= -->
<table class="users-table">
    <thead>
        <tr>
            <th>user_id</th>
            <th>Username</th>
            <th>Roll No</th>
            <th>Department</th>
            <th>Issue</th>
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for user in users %}
        <tr id="user-row-{{ user[0] }}">
            <!-- Display Mode -->
            

    <!-- USER ID -->
    <td>
        {{ user[0] }}
    </td>
            <td>
                <span class="display-mode" id="username-display-{{ user[0] }}">{{ user[1] }}</span>
                <input type="text" class="edit-mode" id="username-edit-{{ user[0] }}" value="{{ user[1] }}" style="display: none;">
            </td>
            <td>
                <span class="display-mode" id="rollno-display-{{ user[0] }}">{{ user[2] }}</span>
                <input type="text" class="edit-mode" id="rollno-edit-{{ user[0] }}" value="{{ user[2] }}" style="display: none;">
            </td>
            <td>
                <span class="display-mode" id="department-display-{{ user[0] }}">{{ user[3] }}</span>
                <input type="text" class="edit-mode" id="department-edit-{{ user[0] }}" value="{{ user[3] }}" style="display: none;">
            </td>

            <!-- ISSUE COLUMN -->
            <td>
                {% if user[5] %}
                    Issue Date: {{ user[5] }} <br>
                    Return Date: {{ user[6] }}
                {% else %}
                    <form method="post" action="{{ url_for('users.issue_book', user_id=user[0]) }}">
                        <button type="submit">Issue</button>
                    </form>
                {% endif %}
            </td>

            <!-- ACTIONS COLUMN -->
            <td>
                <!-- Edit Button (Display Mode) -->
                <button type="button" 
                        class="edit-btn display-mode" 
                        id="edit-btn-{{ user[0] }}"
                        onclick="enableEdit({{ user[0] }})"
                        style="background-color:#ffc107; color:white; margin-right:5px; padding:8px 16px; border:none; border-radius:5px; cursor:pointer;">
                    ‚úèÔ∏è Edit
                </button>

                <!-- Save Button (Edit Mode - Hidden by default) -->
                <button type="button" 
                        class="save-btn edit-mode" 
                        id="save-btn-{{ user[0] }}"
                        onclick="saveUser({{ user[0] }})"
                        style="display: none; background-color:#28a745; color:white; margin-right:5px; padding:8px 16px; border:none; border-radius:5px; cursor:pointer;">
                    üíæ Save
                </button>

                <!-- Cancel Button (Edit Mode - Hidden by default) -->
                <button type="button" 
                        class="cancel-btn edit-mode" 
                        id="cancel-btn-{{ user[0] }}"
                        onclick="cancelEdit({{ user[0] }})"
                        style="display: none; background-color:#6c757d; color:white; margin-right:5px; padding:8px 16px; border:none; border-radius:5px; cursor:pointer;">
                    ‚ùå Cancel
                </button>

                <!-- Delete Button -->
                <form method="post" 
                      action="{{ url_for('users.delete_user', user_id=user[0]) }}"
                      onsubmit="return confirm('Are you sure you want to delete this user?');"
                      style="display: inline;">
                    <button type="submit" style="background-color:#d9534f; color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer;">
                        üóëÔ∏è Delete
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // Store original values for cancel functionality
    const originalValues = {};

    function enableEdit(userId) {
        // Store original values
        originalValues[userId] = {
            username: document.getElementById(`username-display-${userId}`).textContent,
            rollno: document.getElementById(`rollno-display-${userId}`).textContent,
            department: document.getElementById(`department-display-${userId}`).textContent
        };

        // Hide display elements
        document.querySelectorAll(`#user-row-${userId} .display-mode`).forEach(el => {
            el.style.display = 'none';
        });

        // Show edit elements
        document.querySelectorAll(`#user-row-${userId} .edit-mode`).forEach(el => {
            el.style.display = 'inline-block';
        });
    }

    function cancelEdit(userId) {
        // Restore original values
        document.getElementById(`username-edit-${userId}`).value = originalValues[userId].username;
        document.getElementById(`rollno-edit-${userId}`).value = originalValues[userId].rollno;
        document.getElementById(`department-edit-${userId}`).value = originalValues[userId].department;

        // Show display elements
        document.querySelectorAll(`#user-row-${userId} .display-mode`).forEach(el => {
            el.style.display = 'inline-block';
        });

        // Hide edit elements
        document.querySelectorAll(`#user-row-${userId} .edit-mode`).forEach(el => {
            el.style.display = 'none';
        });
    }

    function saveUser(userId) {
        const username = document.getElementById(`username-edit-${userId}`).value;
        const rollno = document.getElementById(`rollno-edit-${userId}`).value;
        const department = document.getElementById(`department-edit-${userId}`).value;

        // Validate inputs
        if (!username.trim() || !rollno.trim() || !department.trim()) {
            alert('All fields are required!');
            return;
        }

        // Send AJAX request to update user
        fetch(`/users/edit/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                roll_no: rollno,
                department: department
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update display values
                document.getElementById(`username-display-${userId}`).textContent = username;
                document.getElementById(`rollno-display-${userId}`).textContent = rollno;
                document.getElementById(`department-display-${userId}`).textContent = department;

                // Show display elements
                document.querySelectorAll(`#user-row-${userId} .display-mode`).forEach(el => {
                    el.style.display = 'inline-block';
                });

                // Hide edit elements
                document.querySelectorAll(`#user-row-${userId} .edit-mode`).forEach(el => {
                    el.style.display = 'none';
                });

                // Show success message
                alert('‚úÖ User updated successfully!');
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå An error occurred while updating the user.');
        });
    }
</script>

<style>
    .edit-mode {
        padding: 8px;
        border: 2px solid #007bff;
        border-radius: 5px;
        font-size: 14px;
        width: 90%;
    }

    .edit-mode:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    .users-table button:hover {
        opacity: 0.9;
        transform: scale(1.05);
        transition: all 0.2s ease;
    }
</style>

{% endblock %}